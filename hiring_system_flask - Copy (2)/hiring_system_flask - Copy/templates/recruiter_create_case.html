{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">ایجاد پرونده</h3>
  <a href="{{ url_for('recruiter.dashboard') }}" class="btn btn-light">بازگشت به پنل</a>
</div>

{% with msgs = get_flashed_messages(with_categories=true) %}
  {% if msgs %}
    {% for cat, msg in msgs %}
      <div class="alert alert-{{ 'danger' if cat=='danger' else cat }} py-2">{{ msg }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="card shadow-sm">
  <div class="card-body">
    <form method="post" class="row g-3" id="createForm">
      {{ form.hidden_tag() }}
      {{ form.force_create(id='force_create') }}

      <!-- هویتی/تماس -->
      <div class="col-md-4">{{ form.full_name.label }} {{ form.full_name(class="form-control") }}</div>
      <div class="col-md-4">{{ form.father_name.label }} {{ form.father_name(class="form-control") }}</div>
      <div class="col-md-4">{{ form.national_id.label }} {{ form.national_id(class="form-control", id="national_id") }}</div>
      <div class="col-md-4">{{ form.mobile.label }} {{ form.mobile(class="form-control", id="mobile") }}</div>
      <div class="col-md-4">{{ form.email.label }} {{ form.email(class="form-control") }}</div>
      <div class="col-md-4">{{ form.home_address.label }} {{ form.home_address(class="form-control") }}</div>

      <!-- وضعیت‌های فردی -->
      <div class="col-md-4">{{ form.gender.label }} {{ form.gender(class="form-select", id="gender") }}</div>
      <div class="col-md-4">{{ form.marital_status.label }} {{ form.marital_status(class="form-select") }}</div>
      <div class="col-md-4" id="military_wrapper">{{ form.military_status.label }} {{ form.military_status(class="form-select", id="military_status") }}</div>

      <!-- سازمان/قرارداد -->
      <div class="col-md-4">{{ form.contract_type.label }} {{ form.contract_type(class="form-select") }}</div>
      <div class="col-md-4">{{ form.org_position.label }} {{ form.org_position(class="form-control") }}</div>
      <div class="col-md-4">{{ form.degree.label }} {{ form.degree(class="form-select") }}</div>

      <!-- شعبه -->
      <div class="col-md-4">{{ form.branch_manager_name.label }} {{ form.branch_manager_name(class="form-control") }}</div>
      <div class="col-md-4">{{ form.branch_manager_mobile.label }} {{ form.branch_manager_mobile(class="form-control") }}</div>
      <div class="col-md-4">{{ form.branch_manager_phone.label }} {{ form.branch_manager_phone(class="form-control") }}</div>
      <div class="col-md-12">{{ form.branch_address.label }} {{ form.branch_address(class="form-control") }}</div>

      <!-- حقوق -->
      <div class="col-md-6">{{ form.approved_salary_type.label }} {{ form.approved_salary_type(class="form-select") }}</div>
      <div class="col-md-6">{{ form.approved_salary_amount.label }} {{ form.approved_salary_amount(class="form-control", id="approved_salary_amount") }}</div>

      <div class="col-12 d-flex gap-2">
        <button class="btn btn-primary">ثبت پرونده</button>
        <a href="{{ url_for('recruiter.dashboard') }}" class="btn btn-light">بازگشت</a>
      </div>
    </form>
  </div>
</div>

{% if show_dup_modal %}
<div class="modal fade show" tabindex="-1" style="display:block; background:rgba(0,0,0,.5);">
  <div class="modal-dialog">
    <div class="modal-content glass shadow">
      <div class="modal-header"><h6 class="modal-title">این شماره کاربری قبلاً در سامانه ثبت شده است.</h6></div>
      <div class="modal-body">
        <div class="p-2 bg-light rounded mb-2">
          <div><strong>نام:</strong> {{ dup_user.full_name }}</div>
          <div><strong>نام‌کاربری:</strong> {{ dup_user.username }}</div>
          <div><strong>موبایل:</strong> {{ dup_user.mobile }}</div>
        </div>
        <p class="mb-0">یکی از گزینه‌ها را انتخاب کنید:</p>
      </div>
      <div class="modal-footer">
        <a href="{{ url_for('recruiter.dashboard') }}" class="btn btn-secondary">انصراف از عملیات</a>
        <a href="{{ url_for('recruiter.view_user', user_id=dup_user.id) }}" class="btn btn-outline-primary">مشاهده اطلاعات کاربر</a>
        <button type="button" class="btn btn-primary" id="btnForceCreate">ثبت کاربر جدید</button>
      </div>
    </div>
  </div>
</div>
<script>
  document.getElementById('btnForceCreate')?.addEventListener('click', ()=>{
    document.getElementById('force_create').value='1';
    document.getElementById('createForm').submit();
  });
</script>
{% endif %}

<style>
  .glass{backdrop-filter:blur(8px);background:rgba(255,255,255,.85);}
</style>

<script>
function toEnDigits(s){
  if(!s) return s;
  const fa="۰۱۲۳۴۵۶۷۸۹", ar="٠١٢٣٤٥٦٧٨٩";
  return s.replace(/[۰-۹]/g, d=>fa.indexOf(d))
          .replace(/[٠-٩]/g, d=>ar.indexOf(d));
}
["national_id","mobile","approved_salary_amount"].forEach(id=>{
  const el=document.getElementById(id);
  if(el){
    el.addEventListener("input", ()=>{ el.value = toEnDigits(el.value); });
    el.value = toEnDigits(el.value);
  }
});

function toggleMilitary(){
  const gender = document.getElementById('gender')?.value;
  const wrap = document.getElementById('military_wrapper');
  if(wrap){
    wrap.style.display = (gender==='male') ? 'block' : 'none';
  }
}
document.getElementById('gender')?.addEventListener('change', toggleMilitary);
toggleMilitary();
</script>
{% endblock %}
